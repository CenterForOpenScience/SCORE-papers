---
title: "SCORE Targets"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 6
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
library(targets)
library(readr)
library(googledrive)
library(googlesheets4)
library(dplyr)
# Silly workaround to get renv to store these packages
library(hashids)
library(usethis)
library(visNetwork)
tar_unscript()
```

The R package `targets` is a [make](https://www.gnu.org/software/make/)-like tool for reproducibly running the code that generates project products, such as analytic datasets, models, and figures. 

Rendering this file using `rmarkdown::render("targets.Rmd")` executes a series of functions in the correct order to build target files (also known as "targets", e.g., analytic datasets, figures) from source files (e.g., raw data). It also documents the dependencies of the target file, including all files (whether source files or other targets) which are used as inputs to the commands in the functions used to generate the target file.

# Globals

We first define the global options and source functions used to generate target files.

```{targets globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE,
        # Gmail authorization for accessing sheets
        # Set google_oauth_email="youremail@cos.io" in your .Renviron file 
        # to use this document without changing the code.
        gargle_oauth_email = Sys.getenv("google_oauth_email"),
        scipen = 999)

googledrive::drive_auth()
googlesheets4::gs4_auth()

tar_option_set(
  # Packages the targets need to run
  packages = c("BayesFactor",
               "BayesRep",
               "BFF", # Version 4.2.1 REQUIRED
               "dplyr",
               "effectsize",
               "ggExtra",
               "glue",
               "googlesheets4",
               "googledrive",
               "here",
               "kableExtra",
               "lubridate",
               "metaBMA",
               "metafor",
               "osfr",
               "purrr",
               "pwr",
               "readr",
               "ReplicationSuccess",
               "sjPlot",
               "stringr",
               "tibble",
               "tidyr") 
)

# All functions used are found in the folder named "pipeline"
tar_source(files = "pipeline")

```

# Targets

## Raw Data

Most raw data files will have three targets associated with them - one for their ID on Google Drive or OSF, one for the modification date of the file, and one that actually represents the data loaded into R. The modification date targets are set to run every time `tar_make()` is called so that the file is pulled again if it is ever updated online. 

### Publication-level Metadata

``` {targets raw-publications}
list(
  # publications.csv -> journal-metadata.csv
  # Journal names, ISSNs, and general publication category
  tar_target(journal_metadata_file,
             "1fXHxIcsFjiAgmydESNkgLjx36dTCSC34"),
  tar_target(journal_metadata_moddate,
             get_google_mod_date(journal_metadata_file),
             cue = tar_cue("always")),
  tar_target(journal_metadata_raw,
             read_google_csv(journal_metadata_file,
                             journal_metadata_moddate)),
  
  # journal-top-factor.csv
  # TOP factor info for SCORE journals
  tar_target(journal_top_factor_file,
             "1hDpl8wHE7RRh9rksO1izx-hRtnjaW9u471yV0scHBnA"),
  tar_target(journal_top_factor_moddate,
             get_google_mod_date(journal_top_factor_file),
             cue = tar_cue("always")),
  tar_target(journal_top_factor,
             read_google_sheet(journal_top_factor_file,
                               journal_top_factor_moddate,
                               sheet = "From TopFactor website")),
  
  # Google Sheet with multiple datasets about journal policies
  # List of journal policies about reproducibility and data/code sharing
  tar_target(repro_journal_policies_file,
             "1KBdGqBUOz5zAMA-Mgv0XPgfzAkJrz28Ikd49jFyc2XA"),
  tar_target(repro_journal_policies_moddate,
             get_google_mod_date(repro_journal_policies_file),
             cue = tar_cue("always")),
  tar_target(repro_journal_policies,
             read_google_sheet(repro_journal_policies_file,
                               repro_journal_policies_moddate,
                               sheet = "Prepared Dataset",
                               skip = 2,
                               col_names = c(
                                 "journal",
                                 "ISSN",
                                 "eISSN",
                                 "verify_match",
                                 "journal_datasheet",
                                 "require_data",
                                 "require_data_year",
                                 "require_data_year_certainty",
                                 "require_data_source_conflict",
                                 "require_code",
                                 "require_code_year",
                                 "require_code_year_certainty",
                                 "require_code_source_conflict",
                                 "repro_checks",
                                 "repro_checks_year",
                                 "repro_checks_year_certainty",
                                 "repro_checks_source_conflict",
                                 "data_lit_review_policy",
                                 "data_lit_review_year",
                                 "data_outreach_policy",
                                 "data_outreach_year",
                                 "data_top_policy",
                                 "data_top_year",
                                 "code_lit_review_policy",
                                 "code_lit_review_year",
                                 "code_outreach_policy",
                                 "code_outreach_year",
                                 "code_top_policy",
                                 "code_top_year",
                                 "repro_lit_review_policy",
                                 "repro_lit_review_year",
                                 "repro_outreach_policy",
                                 "repro_outreach_year",
                                 "repro_top_policy",
                                 "repro_top_year"
                                 )))

)
```

### Paper-level Metadata

```{targets raw-papers}
list(
  # all_metadata_filled.tsv -> article-metadata_crosref-wos.csv
  # Data about the papers from both Web of Science and CrossRef
  tar_target(all_metadata_filled_file,
             "1W-sNolZQegujz82TU2RKe0tfCvofrhm1"),
  tar_target(all_metadata_filled_moddate,
             get_google_mod_date(all_metadata_filled_file),
             cue = tar_cue("always")),
  tar_target(all_metadata_filled,
             read_google_tsv(all_metadata_filled_file,
                             all_metadata_filled_moddate)),

  # covid_metadata.tsv
  # Data about COVID papers
  tar_target(covid_metadata_file,
             "1coSF-yytg1uNvboJ90qWWjrlJMGzjfMu"),
  tar_target(covid_metadata_moddate,
             get_google_mod_date(covid_metadata_file),
             cue = tar_cue("always")),
  tar_target(covid_metadata_raw,
             read_google_tsv(covid_metadata_file,
                             covid_metadata_moddate)),
  
  # Citation information
  tar_target(paper_cite_file,
             "1TaAxr215qejHmNPrJ8_-v7uS6bCl3LFSdCziaEyV-RM"),
  tar_target(paper_cite_moddate,
             get_google_mod_date(paper_cite_file),
             cue = tar_cue("always")),
  tar_target(paper_cite,
             read_google_sheet(paper_cite_file,
                               paper_cite_moddate)),
  

  
  ## Raw data with unknown use ----
  # CR_metadata_prepool.csv
  tar_target(CR_metadata_prepool_file,
             "1FnmZMEYiWBhAj0THZvMetdWzuohraPy3"),
  tar_target(CR_metadata_prepool_moddate,
             get_google_mod_date(CR_metadata_prepool_file),
             cue = tar_cue("always")),
  tar_target(CR_metadata_prepool,
             read_google_csv(CR_metadata_prepool_file,
                             CR_metadata_prepool_moddate)),
  
  # p2_id_key.csv
  # Links cannonical paper ID to the IDs used by other teams
  # Does not include COVID papers
  tar_target(p2_id_key_file,
             "1E9af5ncbY2gm7CvHjrWVJt4x_F-ZbyS1"),
  tar_target(p2_id_key_moddate,
             get_google_mod_date(p2_id_key_file),
             cue = tar_cue("always")),
  tar_target(p2_id_key,
             read_google_csv(p2_id_key_file,
                             p2_id_key_moddate))
  
)
```

### Original Articles

#### Original Study Claims

```{targets raw-claims}
list(
  # tagtable_covid_p1.tsv
  # Claims extracted from phase 1 COVID papers with canonical paper IDs
  # Needed in orig to denote covid papers, and for IDs in PR
  tar_target(tagtable_covid_p1_file,
             "1lc2P9N2RPXR2YZB6_Zh1E8eXNiRdm50t"),
  tar_target(tagtable_covid_p1_moddate,
             get_google_mod_date(tagtable_covid_p1_file),
             cue = tar_cue("always")),
  tar_target(tagtable_covid_p1,
             read_google_tsv(tagtable_covid_p1_file,
                             tagtable_covid_p1_moddate)),
  
  # stitched_claims.tsv
  # All bushel claims with canonical paper IDs
  tar_target(stitched_claims_file,
             "1v_ci1nEomtT1ZJKaOeJXqauCsmQJG40b"),
  tar_target(stitched_claims_moddate,
             get_google_mod_date(stitched_claims_file),
             cue = tar_cue("always")),
  tar_target(stitched_claims,
             read_google_tsv(stitched_claims_file,
                             stitched_claims_moddate)),
  
  # P1 claims
  tar_target(tagtable_p1_file,
             "1NmhTX53-SWsMpIbgZpm2bWm1SzRq071F"),
  tar_target(tagtable_p1_moddate,
             get_google_mod_date(tagtable_p1_file),
             cue = tar_cue("always")),
  tar_target(tagtable_p1,
             read_google_tsv(tagtable_p1_file,
                             tagtable_p1_moddate)),
  
  # P2 claims
  tar_target(tagtable_p2_CES_file,
             "1Lr2SXHO261GaifluZSZ1kl7OjjbnHrqe"),
  tar_target(tagtable_p2_CES_moddate,
             get_google_mod_date(tagtable_p2_CES_file),
             cue = tar_cue("always")),
  tar_target(tagtable_p2_CES,
             read_google_tsv(tagtable_p2_CES_file,
                             tagtable_p2_CES_moddate)),
  
  # covid_ta2.csv
  # Claims extracted from phase 1 COVID papers with paper IDs for TA2
  # Used to reconcile IDs in process reproducibility
  tar_target(covid_ta2_osf,
             "yr3w8"),
  tar_target(covid_ta2_mod_date, 
             get_osf_mod_date(covid_ta2_osf),
             cue = tar_cue("always")), 
  tar_target(covid_ta2,
             load_osf_csv(covid_ta2_osf,
                          covid_ta2_mod_date)),
  
  # Complex Bushel
  tar_target(complex_bushel_gsheet,
             "1hlcidipFCVV4WlGyCT6cMDFjyQsGA8CCoGUFASuQAhY"),
  tar_target(complex_bushel_mod_date,
             get_google_mod_date(complex_bushel_gsheet),
             cue = tar_cue("always")),
  tar_target(complex_bushel,
             read_google_sheet(complex_bushel_gsheet,
                               complex_bushel_mod_date))
)
```

#### Original Study Variables
```{targets raw-original-variables}
list(
  # orig_statistics_dataset_p1.tsv
  tar_target(orig_statistics_p1_file,
             "1TLm9loSU8n3pSRoz0ugekJ6VfSiS792p"),
  tar_target(orig_statistics_p1_moddate,
             get_google_mod_date(orig_statistics_p1_file),
             cue = tar_cue("always")),
  tar_target(
    orig_statistics_dataset_p1,
    read_google_tsv(
      orig_statistics_p1_file,
      orig_statistics_p1_moddate,
      col_types = list(
        # All load in by default as character, so manually set to double
        original_statistic_value_reported = col_double(),
        original_statistic_df1_reported = col_double(),
        original_statistic_df2_reported = col_double(),
        # There is a weird data corruption in this field that throws a warning, 
        # but it gets fixed in the changelog:
        original_coefficient_value_reported = col_double(),
        original_coefficient_se_reported = col_double(),
        original_effect_size_value_reported = col_double(),
        original_analytic_sample_size_value_reference = col_double(),
        original_statistic_value_reference = col_double(),
        original_statistic_df1_reference = col_double(),
        original_statistic_df2_reference = col_double(),
        original_coefficient_se_reference = col_double(),
        original_p_value_value_reference = col_double(),
        original_effect_size_value_reference = col_double(),
        rr_threshold_analytic_sample_size = col_double(),
        rr_stage1_analytic_sample_size = col_double(),
        rr_stage2_analytic_sample_size = col_double(),
        original_total_model_parameters = col_double()
      )
    )
  ),
  
  # orig_statistics_manual_dataset.tsv
  tar_target(orig_statistics_manual_file,
             "1B8-fTy_wpCcwHJAGt8FZKIuIoeHeE0T6"),
  tar_target(orig_statistics_manual_moddate,
             get_google_mod_date(orig_statistics_manual_file),
             cue = tar_cue("always")),
  tar_target(
    orig_statistics_manual_data_entry,
    read_google_tsv(
      orig_statistics_manual_file,
      orig_statistics_manual_moddate,
      col_types = list(
        # originally: logical
        original_statistic_type_reported = col_character(),
        original_statistic_type_reference = col_character()
      )
    )
  ),
  
  # original_inftest_dataset.tsv
  tar_target(original_inftest_file,
             "1goGxpXYcpCWNxBa1HE1oEEifVFlUOix7"),
  tar_target(original_inftest_moddate,
             get_google_mod_date(original_inftest_file),
             cue = tar_cue("always")),
  tar_target(original_inftest_dataset,
             read_google_tsv(original_inftest_file,
                             original_inftest_moddate)),
  
  # SCORE-P2-103: Original variables coding form (Responses)
  tar_target(orig_vars_qa_gsheet,
             "1_rgG3r318tpsakc8wSA0dMAYJ--pkiybVq5s9dfek6M"),
  tar_target(orig_vars_qa_mod_date,
             get_google_mod_date(orig_vars_qa_gsheet),
             cue = tar_cue("always")), 
  tar_target(orig_vars_qa,
             read_google_sheet(orig_vars_qa_gsheet,
                               orig_vars_qa_mod_date)),
  
  # Added SCORE variables - Gsheet
  tar_target(effectsize_gsheet,
             "1tS_M7RcyWIkXlDf13TqSfGdvWXBL_m9lgcV8ML34Jdo"),
  tar_target(effectsize_moddate,
             get_google_mod_date(effectsize_gsheet),
             cue = tar_cue("always")),
  
  # Added SCORE variables - Original
  tar_target(effectsize_orig,
             read_google_sheet(effectsize_gsheet,
                               effectsize_moddate,
                               sheet = "original")),
  
  # orig_statistics_output_p2.tsv
  tar_target(orig_statistics_output_p2_osf,
             "hk63r"),
  tar_target(orig_statistics_output_p2_mod_date, 
             get_osf_mod_date(orig_statistics_output_p2_osf),
             cue = tar_cue("always")), 
  tar_target(
    orig_statistics_output_p2,
    load_osf_tsv(orig_statistics_output_p2_osf,
                 orig_statistics_output_p2_mod_date,
                 quote = "\\\"")
  ),
  
  # Additional Cases - Gsheet
  tar_target(repli_cases_gsheet,
             "1y57RNOH96x8dXYc8gxBbCQOmuaMVOoaD0KgJYfoITmg"),
  tar_target(repli_cases_moddate,
             get_google_mod_date(repli_cases_gsheet),
             cue = tar_cue("always")),
  
  # Additional Cases - Original Variables
  tar_target(orig_cases,
             read_google_sheet(repli_cases_gsheet,
                               repli_cases_moddate,
                               sheet = "orig_dataset"))
)
```

### Replications and Reproductions

#### Replications

```{targets replications}
list(
  # File: SCORE-P2-081: Variable form - replications (Responses)
  tar_target(replication_qa_gsheet,
             "1Cs7iFLA29JwVDfp8DY0ZIaTlRTTnK0KsFSudLDHxjFQ"),
  tar_target(replication_qa_mod_date,
             get_google_mod_date(replication_qa_gsheet)),
  tar_target(replication_qa_raw,
             read_google_sheet(replication_qa_gsheet,
                               replication_qa_mod_date),
             cue = tar_cue("always")),
  
  # Additional cases - replications
  tar_target(replication_cases,
             read_google_sheet(repli_cases_gsheet,
                               repli_cases_moddate,
                               sheet = "repli_export")),

  # Replication case exclusions
  tar_target(repli_case_exclusions_gsheet,
             "17cyjatTcqN36_vZ_IvWtcr4n2Ep-KlKJ-PS3K-q6wdU"),
  tar_target(repli_case_exclusions_mod_date,
             get_google_mod_date(repli_case_exclusions_gsheet),
             cue = tar_cue("always")), 
  tar_target(repli_case_exclusions,
             read_google_sheet(repli_case_exclusions_gsheet,
                               repli_case_exclusions_mod_date)),

  # rr_outcomes_dataset_p1.tsv
  tar_target(rr_outcomes_dataset_p1_file,
             "113CSsObKagvQToj-inv4bO3KaS5zif6D"),
  tar_target(rr_outcomes_dataset_p1_moddate,
             get_google_mod_date(rr_outcomes_dataset_p1_file),
             cue = tar_cue("always")),
  tar_target(rr_outcomes_dataset_p1,
             read_google_tsv(rr_outcomes_dataset_p1_file,
                             rr_outcomes_dataset_p1_moddate)),
  
  # Added SCORE variables - Replication
  tar_target(effectsize_repli,
             read_google_sheet(effectsize_gsheet,
                               effectsize_moddate,
                               sheet = "replication")),
  
  # rr_statistics_output_p2.txt
  tar_target(rr_statistics_output_p2_osf,
             "6u7hc"),
  tar_target(rr_statistics_output_p2_mod_date, 
             get_osf_mod_date(rr_statistics_output_p2_osf),
             cue = tar_cue("always")), 
  tar_target(
    rr_statistics_output_p2,
    load_rr_statistics_output_p2(rr_statistics_output_p2_osf,
                                 rr_statistics_output_p2_mod_date)
  )
)
```

#### Reproductions

```{targets reproductions}
list(
  # Additional cases - reproductions
  tar_target(reproduction_cases,
             read_google_sheet(repli_cases_gsheet,
                               repli_cases_moddate,
                               sheet = "repro_export")),
  
  # File: SCORE-P2-113: Variable form - reproductions (Responses)
  tar_target(reproduction_qa_gsheet,
             "1vCVHLymiT-IcVGvWH_a3cJ4dfhjrf8lvmi4qe24LuZs"),
  tar_target(reproduction_qa_moddate,
             get_google_mod_date(reproduction_qa_gsheet),
             cue = tar_cue("always")),
  tar_target(reproduction_qa,
             read_google_sheet(reproduction_qa_gsheet,
                               reproduction_qa_moddate),
             cue = tar_cue("always")),
  
  # File: SCORE-P2-097: Prereg check-in form (Reproduction) (Responses)
  tar_target(prereg_checkin_repro_gsheet,
             "11UCF2cuoBwLfJrQZC7AoWqG7EjCBoxV_GC-aFMsy6u4"),
  tar_target(prereg_checkin_repro_moddate,
             get_google_mod_date(prereg_checkin_repro_gsheet),
             cue = tar_cue("always")),
  tar_target(prereg_checkin_repro,
             read_google_sheet(prereg_checkin_repro_gsheet,
                               prereg_checkin_repro_moddate),
             cue = tar_cue("always")),
  
  # File: repro_vor
  # Reproduction Version of Record
  tar_target(repro_vor_gsheet,
             "1jxgJQDIiKOOodtZR9bTLoBxZya4KlGexhwi2SekbBU0"),
  tar_target(repro_vor_moddate,
             get_google_mod_date(repro_vor_gsheet),
             cue = tar_cue("always")),
  tar_target(repro_vor,
             read_google_sheet(repro_vor_gsheet,
                               repro_vor_moddate,
                               sheet = "repro_version_of_record"))
)
```

#### Outcomes

```{targets raw-score}
list(
  # Added SCORE variables - Outcomes
  tar_target(effectsize_outcome,
             read_google_sheet(effectsize_gsheet,
                               effectsize_moddate,
                               sheet = "outcomes"))
)
```

<!-- ### Helpers -->

<!-- The `valid_ids` object is used to check that files being loaded in the following sections only use valid IDs. Also load in `rr_projects.csv` here for convenience since it is used to generate the list of valid IDs.  -->

<!-- The `id_key` object is used to match up the canonical paper IDs with the IDs assigned to papers for TA2 and TA3.  -->

<!-- ```{targets helpers} -->
<!-- list( -->



<!--   # tar_target(valid_ids, -->
<!--   #            create_id_list(status, -->
<!--   #                           tagtable_covid_p1, -->
<!--   #                           finalized_claim4_table, -->
<!--   #                           rr_projects)), -->
<!--   # Temp rr project list -->
<!--   # tar_target(all_rr_attempts_gsheet, -->
<!--   #            "13YmuK4UxMEreDNHY4WfjEqDHOi2Htlvwh4wxwbVK25U"), -->
<!--   # tar_target(all_rr_attempts_moddate, -->
<!--   #            get_google_mod_date(all_rr_attempts_gsheet), -->
<!--   #            cue = tar_cue("always")), -->
<!--   # tar_target(all_rr_attempts, -->
<!--   #            read_google_sheet(all_rr_attempts_gsheet, -->
<!--   #                              all_rr_attempts_moddate, -->
<!--   #                              sheet = "full_sweep")) -->
<!--   #  -->
<!--   # tar_target(id_key, -->
<!--   #            create_id_key(covid_ta2, -->
<!--   #                         tagtable_covid_p1, -->
<!--   #                         status, -->
<!--   #                         p2_id_key, -->
<!--   #                         SCORE_CVD2, -->
<!--   #                         stitched_claims, -->
<!--   #                         replication_qa, -->
<!--   #                         reproduction_qa)) -->
<!-- ) -->
<!-- ``` -->

### Process Reproducibility

```{targets raw-pr}
list(
  # COS SCORE Data Google Drive - raw/process_reproducibility ----
  # https://drive.google.com/drive/folders/1y2X2jFBH7t6wDhviEqI85rbniYtm33AK
  
  # Original Author Outreach (OA_outreach_PR_coding)
  tar_target(oa_sheet,
             "1ke9auRcjFeFscpH53zM98dV6_ObpKckzX-YaXRzkuIw",
             cue = tar_cue("always")),
  
  # Process Reproducibility
  tar_target(pr_gsheet,
             "1E8LvpcuoUyVZV-EDqVPW_H1Cd-4OJCuR3Kl8HMJMVtI",
             cue = tar_cue("always")),
  tar_target(pr_data_raw,
             load_pr_data(pr_gsheet))
)
```

### Auxiliary Datasets

```{targets aux-data}
list(
  # Non-significant bushels
  # Coding out significant vs non-significant bushel claims
  tar_target(non_significant_bushels_gsheet,
             "1C89wRO_dZ1_qq9Ow0RpaWK2jWteloo9zPS9pW9VdbP0"),
  tar_target(non_significant_bushels_moddate,
             get_google_mod_date(non_significant_bushels_gsheet),
             cue = tar_cue("always")),
  tar_target(non_significant_bushels,
             read_google_sheet(non_significant_bushels_gsheet,
                               non_significant_bushels_moddate,
                               sheet = "claims")),
  
  # RR sourced 
  # All replication and reproduction projects that were matched with a team. 
  tar_target(rr_sourced_gsheet,
             "1EyUGgw8uGaCIP9nLXKh3IwqqU4DoAM4ZV6K5i1dOTHo"),
  tar_target(rr_sourced_moddate,
             get_google_mod_date(rr_sourced_gsheet),
             cue = tar_cue("always")),
  tar_target(rr_sourced,
             read_google_sheet(rr_sourced_gsheet,
                               rr_sourced_moddate,
                               sheet = "sourced",
                               drop_cols = "indicator")),
  
  # Never sourced
  # Reasons why non-matched papers were not plausible for replication
  tar_target(never_sourced_gsheet,
             "1OVfv_dDsfAeBOtx9-IaTNgPJv5-OFaHS4cK45aYsBpo"),
  tar_target(never_sourced_moddate,
             get_google_mod_date(never_sourced_gsheet),
             cue = tar_cue("always")),
  tar_target(never_sourced,
             read_google_sheet(never_sourced_gsheet,
                               never_sourced_moddate,
                               sheet = "never_sourced",
                               drop_cols = c("paper_link", "confidence"))),
  
  # Alternative Power Coding
  tar_target(ser_vs_traditional_gsheet,
             "1hGT5cEnadMVocvu-9LnfnFfZRZadYCjjPiFy41zwxWw"),
  tar_target(ser_vs_traditional_moddate,
             get_google_mod_date(ser_vs_traditional_gsheet),
             cue = tar_cue("always")),
  
  ## Traditional
  tar_target(traditional_power,
             read_google_sheet(ser_vs_traditional_gsheet,
                               ser_vs_traditional_moddate,
                               sheet = "traditional")),
  ## SER
  tar_target(ser_power,
             read_google_sheet(ser_vs_traditional_gsheet,
                               ser_vs_traditional_moddate,
                               sheet = "ser")),
  
  # Preregistration Indicators
  # Whether the original paper mentions preregistration
  tar_target(prereg_indicators_file,
             "1fOO4EoOkM8uswzgFczBlArsHbrf2KFeE"),
  tar_target(prereg_indicators_moddate,
             get_google_mod_date(prereg_indicators_file),
             cue = tar_cue("always")),
  tar_target(prereg_indicators,
             read_google_csv(prereg_indicators_file,
                             prereg_indicators_moddate,
                             col_types = c("clcd"))),
  
  # Summary of methodological approaches in original studies.
  # llm_method_data.csv
  tar_target(llm_method_data_file,
             "vxysn"),
  tar_target(llm_method_data_moddate,
             get_osf_mod_date(llm_method_data_file)),
  tar_target(llm_method_data,
             load_osf_csv(llm_method_data_file,
                          llm_method_data_moddate)),
  
  # Summary of research questions in original studies
  # llm_research_question_table.csv
  tar_target(llm_research_question_table_file,
             "mg794"),
  tar_target(llm_research_question_table_moddate,
             get_osf_mod_date(llm_research_question_table_file)),
  tar_target(llm_research_question_table,
             load_osf_csv(llm_research_question_table_file,
                          llm_research_question_table_moddate)),
  
  # Summary of theoretical frameworks of original studies
  # llm_theory_data.csv
  tar_target(llm_theory_data_file,
             "mp3rq"),
  tar_target(llm_theory_data_moddate,
             get_osf_mod_date(llm_theory_data_file)),
  tar_target(llm_theory_data,
             load_osf_csv(llm_theory_data_file,
                          llm_theory_data_moddate))
)
```

### Correlations Datasets

```{targets correlations}
list(
  # Elicitations ----
  # Elicitations phase 1
  tar_target(melb_p1_osf,
             "7n2qe"),
  tar_target(melb_p1_mod_date, 
             get_osf_mod_date(melb_p1_osf),
             cue = tar_cue("always")), 
  tar_target(melb_p1,
             load_osf_csv(melb_p1_osf,
                          melb_p1_mod_date)),
  
  # Elicitations phase 2
  tar_target(melb_p2_osf,
             "9khpj"),
  tar_target(melb_p2_mod_date, 
             get_osf_mod_date(melb_p2_osf),
             cue = tar_cue("always")), 
  tar_target(melb_p2,
             load_osf_csv(melb_p2_osf,
                          melb_p2_mod_date)),
  
  # Elicitations bushel
  tar_target(melb_bushel_osf,
             "wy9sv"),
  tar_target(melb_bushel_mod_date, 
             get_osf_mod_date(melb_bushel_osf),
             cue = tar_cue("always")), 
  tar_target(melb_bushel,
             load_osf_csv(melb_bushel_osf,
                          melb_bushel_mod_date)),
  
  # Prediction Markets ----
  tar_target(kw_scores_osf,
             "jn9dg"),
  tar_target(kw_scores_mod_date, 
             get_osf_mod_date(kw_scores_osf),
             cue = tar_cue("always")), 
  tar_target(kw_scores,
             load_osf_csv(kw_scores_osf,
                          kw_scores_mod_date)),
  
  # A+ ----
  # A+ sprint 1
  tar_target(ts_s1_osf,
             "56xqd"),
  tar_target(ts_s1_mod_date, 
             get_osf_mod_date(ts_s1_osf),
             cue = tar_cue("always")), 
  tar_target(ts_s1,
             load_osf_csv(ts_s1_osf,
                          ts_s1_mod_date)),
  
  # A+ sprint 2
  tar_target(ts_s2_osf,
             "c28g4"),
  tar_target(ts_s2_mod_date, 
             get_osf_mod_date(ts_s2_osf),
             cue = tar_cue("always")), 
  tar_target(ts_s2,
             load_osf_csv(ts_s2_osf,
                          ts_s2_mod_date)),
  
  # A+ sprint 3
  tar_target(ts_s3_osf,
             "2z96n"),
  tar_target(ts_s3_mod_date, 
             get_osf_mod_date(ts_s3_osf),
             cue = tar_cue("always")), 
  tar_target(ts_s3,
             load_osf_csv(ts_s3_osf,
                          ts_s3_mod_date)),
  
  # A+ bushel
  tar_target(ts_bushel_osf,
             "d8kc3"),
  tar_target(ts_bushel_mod_date, 
             get_osf_mod_date(ts_bushel_osf),
             cue = tar_cue("always")), 
  tar_target(ts_bushel,
             load_osf_csv(ts_bushel_osf,
                          ts_bushel_mod_date)),
  
  # MACROSCORE ----
  # MACROSCORE sprint 1
  tar_target(usc_s1_osf,
             "u8qea"),
  tar_target(usc_s1_mod_date, 
             get_osf_mod_date(usc_s1_osf),
             cue = tar_cue("always")), 
  tar_target(usc_s1,
             load_osf_csv(usc_s1_osf,
                          usc_s1_mod_date)),
  
  # MACROSCORE sprint 2
  tar_target(usc_s2_osf,
             "xc396"),
  tar_target(usc_s2_mod_date, 
             get_osf_mod_date(usc_s2_osf),
             cue = tar_cue("always")), 
  tar_target(usc_s2,
             load_osf_csv(usc_s2_osf,
                          usc_s2_mod_date)),
  
  # MACROSCORE sprint 3
  tar_target(usc_s3_osf,
             "9rcd7"),
  tar_target(usc_s3_mod_date, 
             get_osf_mod_date(usc_s3_osf),
             cue = tar_cue("always")), 
  tar_target(usc_s3,
             load_osf_csv(usc_s3_osf,
                          usc_s3_mod_date)),
  
  # MACROSCORE bushel
  tar_target(usc_bushel_osf,
             "jmdpk"),
  tar_target(usc_bushel_mod_date, 
             get_osf_mod_date(usc_bushel_osf),
             cue = tar_cue("always")), 
  tar_target(usc_bushel,
             load_osf_csv(usc_bushel_osf,
                          usc_bushel_mod_date)),
  
  # Synthetic Markets ----
  # Synthetic markets sprint 1
  tar_target(psu_s1_osf,
             "u7dnr"),
  tar_target(psu_s1_mod_date, 
             get_osf_mod_date(psu_s1_osf),
             cue = tar_cue("always")), 
  tar_target(psu_s1,
             load_osf_csv(psu_s1_osf,
                          psu_s1_mod_date)),
  
  # Synthetic markets sprint 2
  tar_target(psu_s2_osf,
             "efp92"),
  tar_target(psu_s2_mod_date, 
             get_osf_mod_date(psu_s2_osf),
             cue = tar_cue("always")), 
  tar_target(psu_s2,
             load_osf_csv(psu_s2_osf,
                          psu_s2_mod_date)),
  
  # Synthetic markets sprint 3
  tar_target(psu_s3_osf,
             "rc6aw"),
  tar_target(psu_s3_mod_date, 
             get_osf_mod_date(psu_s3_osf),
             cue = tar_cue("always")), 
  tar_target(psu_s3,
             load_osf_csv(psu_s3_osf,
                          psu_s3_mod_date)),
  
  # Sciscore ----
  tar_target(sciscore_file,
             "1YSXZHGfSwEY3zSwReaq6iJQcUT4HT_qE"),
  tar_target(sciscore_moddate,
             get_google_mod_date(sciscore_file),
             cue = tar_cue("always")),
  tar_target(sciscore,
             read_google_csv(sciscore_file,
                             sciscore_moddate)),
  
  # StatCheck ----
  tar_target(statcheck_file,
             "1mcdyTvXchktzYl3IoOLF_pDFLADH2zKi"),
  tar_target(statcheck_moddate,
             get_google_mod_date(statcheck_file),
             cue = tar_cue("always")),
  tar_target(statcheck,
             read_google_tsv(statcheck_file,
                             statcheck_moddate)),
  
  # Robustness ----
  tar_target(m100_file,
             "1EvH6fblQZqMpumlNAj1U6CPH6e68RJMu"),
  tar_target(m100_moddate,
             get_google_mod_date(m100_file),
             cue = tar_cue("always")),
  tar_target(m100,
             read_google_csv(m100_file,
                             m100_moddate)),
  
  # Original claims effect sizes ----
  tar_target(es_file,
             "1k42kApZgmSyyC1A-EsUoimFmNEc5cDuJLZGk4GrQQjA"),
  tar_target(es_moddate,
             get_google_mod_date(es_file),
             cue = tar_cue("always")),
  tar_target(es,
             read_google_sheet(es_file,
                               es_moddate)),
  
  # Original claims significance ----
  # stat_sig and stat_sig_p2 sheets needed, merged
  tar_target(sig_file,
             "1_ZRyWIrPOO3JwzGTUZOMMLo7fKcENAOwW6tmtSxQ_js"),
  tar_target(sig_moddate,
             get_google_mod_date(sig_file),
             cue = tar_cue("always")),
  tar_target(stat_sig,
             read_google_sheet(sig_file,
                               sig_moddate,
                               sheet = "stat_sig")),
  tar_target(stat_sig_p2,
             read_google_sheet(sig_file,
                               sig_moddate,
                               sheet = "stat_sig_p2") %>%
               add_column(p_value_avail = NA_character_)),
  tar_target(sig,
             rbind(stat_sig, stat_sig_p2)),
  
  # Hedging and humility ----
  tar_target(hedge_file,
             "16-7o5x0j2jJEEVw6E1vyUl_2vG2Xnjap"),
  tar_target(hedge_moddate,
             get_google_mod_date(hedge_file),
             cue = tar_cue("always")),
  tar_target(hedge,
             read_google_tsv(hedge_file,
                             hedge_moddate)),
  
  # Original author metadata ----
  tar_target(oa_metadata_file,
             "1YquUUy2-OdUe0DpTR-7qF29f0t5HxOOz"),
  tar_target(oa_metadata_moddate,
             get_google_mod_date(oa_metadata_file),
             cue = tar_cue("always")),
  tar_target(oa_metadata,
             read_google_csv(oa_metadata_file,
                             oa_metadata_moddate)),
  
  # Original author citations ----
  tar_target(oa_citations_file,
             "1gwj6SZfZI8Gw6fcWAsK6f65oKyDsyC-6"),
  tar_target(oa_citations_moddate,
             get_google_mod_date(oa_citations_file),
             cue = tar_cue("always")),
  tar_target(oa_citations,
             read_google_rds(oa_citations_file,
                             oa_citations_moddate) %>%
               # Warnings expected as "NA" the string changes to NA
               mutate(cs = as.numeric(cs),
                      log_count = as.numeric(log_count))),
  
  # DataSeer ----
  tar_target(dataseer_file,
             "1j9680t7HeRV9cRfOlROCNBrH_SAILNe5"),
  tar_target(dataseer_moddate,
             get_google_mod_date(dataseer_file),
             cue = tar_cue("always")),
  tar_target(dataseer,
             read_google_rds(dataseer_file,
                             dataseer_moddate)),
  
  # Automated bibliometric analyses ----
  tar_target(ksu_file,
             "1T1mD0wdCafBm5vu0JaHRl3HuSHVaxEJ2"),
  tar_target(ksu_moddate,
             get_google_mod_date(ksu_file),
             cue = tar_cue("always")),
  tar_target(ksu,
             read_google_csv(ksu_file,
                             ksu_moddate)),
  
  # Extracted open science indicators ----
  tar_target(scholarcy_file,
             "1G1ipJh-aaF5_GdNJU7qUb6Kd2nEWPzyn"),
  tar_target(scholarcy_moddate,
             get_google_mod_date(scholarcy_file),
             cue = tar_cue("always")),
  tar_target(scholarcy,
             read_google_csv(scholarcy_file,
                             scholarcy_moddate))
  
)

```

### Project Management

Some information comes from datasets used in project management.

```{targets rr-projects}
list(
    # status.csv
  # Canonical source for sub-samples of the data
  # Does not contain COVID papers
  tar_target(status_file,
             "1lETiML-WFVGK1MS0ELCZejIaXnDDXYWh"),
  tar_target(status_moddate,
             get_google_mod_date(status_file),
             cue = tar_cue("always")),
  tar_target(status,
             read_google_csv(status_file,
                             status_moddate)),
    # Full Dates
  # Start and end dates of projects
  tar_target(full_dates_file,
             "1YHuWhvE_8tGFPe_L-yYfCYsZ7xBDRxSa"),
  tar_target(full_dates_moddate,
             get_google_mod_date(full_dates_file),
             cue = tar_cue("always")),
  tar_target(full_dates,
             read_google_csv(full_dates_file,
                             full_dates_moddate,
                             col_types = c("cccDDD"))),
  # rr_projects.csv
  tar_target(rr_projects_file,
             "11paXdFzhCmz8ywFomUhZ6qrfp1wlKLIx"),
  tar_target(rr_projects_moddate,
             get_google_mod_date(rr_projects_file),
             cue = tar_cue("always")),
  tar_target(rr_projects_raw,
             read_google_csv(rr_projects_file,
                             rr_projects_moddate)),
  
  # Additional cases - rr projects 
  tar_target(repli_cases_projects,
             read_google_sheet(repli_cases_gsheet,
                               repli_cases_moddate,
                               sheet = "rr_projects")),
  
  # rr_reporting_checkin.tsv
  # This info is used once and then dropped -- REMOVE   
  tar_target(rr_reporting_checkin_file,
             "1jB97FM-desZatqabwBVMPrSYk0qXWFjM"),
  tar_target(rr_reporting_checkin_moddate,
             get_google_mod_date(rr_reporting_checkin_file),
             cue = tar_cue("always")),
  tar_target(rr_reporting_checkin,
             read_google_tsv(rr_reporting_checkin_file,
                             rr_reporting_checkin_moddate)),
  
  # Not Used - REMOVE
  # # p2_repli_vf.csv
  # tar_target(p2_repli_vf_file,
  #            "1fwWX7ebwhBF9IYt2dQyhEByBnRNavOmj"),
  # tar_target(p2_repli_vf_moddate,
  #            get_google_mod_date(p2_repli_vf_file),
  #            cue = tar_cue("always")),
  # tar_target(p2_repli_vf,
  #            read_google_csv(p2_repli_vf_file,
  #                            p2_repli_vf_moddate)),
  
  # rr_attempts_minted.csv
  # Status and tracking for rr projects. 
  # Source for if a replication is a "generalizibility" 
  tar_target(rr_attempts_minted_file,
             "1aHuTwRVeqADWVC4Lxq5n3B4ebbSa9Mqc"),
  tar_target(rr_attempts_minted_moddate,
             get_google_mod_date(rr_attempts_minted_file),
             cue = tar_cue("always")),
  tar_target(rr_attempts_minted_raw,
             read_google_csv(rr_attempts_minted_file,
                             rr_attempts_minted_moddate))
  
)
```

## Change Logs

```{targets change-logs}
list(
    # Publications Changelog
  tar_target(pub_changelog_file,
             "1CM0wbYnRvBMIyDVFzvwxw3GVH_uRJ3BXRtdwlxTmS1A"),
  tar_target(pub_changelog_moddate,
             get_google_mod_date(pub_changelog_file),
             cue = tar_cue("always")),
  tar_target(pub_changelog,
             load_changelog(pub_changelog_file,
                            pub_changelog_moddate)),
  
  # orig_input_changelog (Google Sheet)
  tar_target(orig_input_changelog_file,
             "1M8H_76ajxwdhVuuSyIo18BxRrJbMF3hXpAkzYY39g2k"),
  tar_target(orig_input_changelog_moddate,
             get_google_mod_date(orig_input_changelog_file),
             cue = tar_cue("always")),
  tar_target(orig_input_changelog,
             load_changelog(orig_input_changelog_file,
                            orig_input_changelog_moddate)),
  
  # rr_attempts_minted_changelog (Google Sheet)
  tar_target(rr_attempts_minted_changelog_file,
             "1rlVy9A4jBwQzpxTH4my4FUWaZkq7388YfpRmQOZWihw"),
  tar_target(rr_attempts_minted_changelog_moddate,
             get_google_mod_date(rr_attempts_minted_changelog_file),
             cue = tar_cue("always")),
  tar_target(rr_attempts_minted_changelog,
             load_changelog(rr_attempts_minted_changelog_file,
                            rr_attempts_minted_changelog_moddate)),
  
  # repli_input_changelog (Google Sheet)
  tar_target(repli_input_changelog_file,
             "1jbkVYHLinIN9zXBuPTok26bHjDt69-7D_Z7yVOin3mM"),
  tar_target(repli_input_changelog_moddate,
             get_google_mod_date(repli_input_changelog_file),
             cue = tar_cue("always")),
  tar_target(repli_input_changelog,
             load_changelog(repli_input_changelog_file,
                            repli_input_changelog_moddate)),
  
  # p2_repro_input_changelog (Google Sheet)
  tar_target(p2_repro_input_changelog_file,
             "1c2i_k-RMzTWAC7RD6cqhheToihtS8_C5r5powvRuMDE"),
  tar_target(p2_repro_input_changelog_moddate,
             get_google_mod_date(repli_input_changelog_file),
             cue = tar_cue("always")),
  tar_target(p2_repro_input_changelog,
             load_changelog(p2_repro_input_changelog_file,
                            p2_repro_input_changelog_moddate)),
  
  # repro_supplement_changelog (Google Sheet)
  tar_target(repro_supplement_changelog_file,
             "1OzOpJCJCy5OPYISk1UR5tI0ehNaou-ykAeD7GPZ99ug"),
  tar_target(repro_supplement_changelog_moddate,
             get_google_mod_date(repro_supplement_changelog_file),
             cue = tar_cue("always")),
  tar_target(repro_supplement_changelog,
             load_changelog(repro_supplement_changelog_file,
                            repro_supplement_changelog_moddate)),
  
  tar_target(pr_changelog_gsheet,
             "1zek9Lu-s303ZXs3B84h2vy-sJ1avOZSgpZEsna40pdA"),
  tar_target(pr_changelog_moddate,
             get_google_mod_date(pr_changelog_gsheet),
             cue = tar_cue("always")),
  tar_target(pr_input_changelog,
             load_changelog(pr_changelog_gsheet,
                            pr_changelog_moddate)),
  
  tar_target(oa_changelog_file,
             "1mrH4mPCr6VUrOD8S08hhzD3jdcRjOnMPAF9XfZ0_vH4"),
  tar_target(oa_changelog_moddate,
             get_google_mod_date(oa_changelog_file),
             cue = tar_cue("always")),
  tar_target(oa_changelog,
             load_changelog(oa_changelog_file,
                            oa_changelog_moddate))
)
```

## Intermediate Data

### Publications

```{targets publications}
list(

  # Update and Transform ----
  tar_target(journal_metadata_updated,
             transform_pubs(journal_metadata_raw,
                            pub_changelog))
)
```

### Paper Metadata

```{targets paper-metadata}
list(

  # Transform ----
  # Metadata for covid papers was collected separately from other papers
  # Reconcile differences for merging
  tar_target(covid_metadata,
             transform_covid_metadata(covid_metadata_raw)),
  
  tar_target(non_covid_metadata,
             transform_paper_metadata(all_metadata_filled, status))
)

```



### Original Study Variables

```{targets original-outcomes}
list(
  ## Merge ----
  tar_target(orig_merged,
             merge_orig_input(orig_statistics_dataset_p1,
                              original_inftest_dataset,
                              orig_statistics_manual_data_entry,
                              orig_vars_qa,
                              tagtable_covid_p1,
                              orig_cases)),
  ## Update ----
  tar_target(orig_updated,
             update_orig_input(orig_merged,
                               orig_input_changelog)),
  
  ## Refine ----
  tar_target(orig_dataset,
             export_orig(orig_updated,
                         orig_statistics_output_p2))
)
```

### Replication/Reproduction Projects
```{targets projects}
list(
  ## Merge ----
  tar_target(rr_projects,
             extend_rr_projects(rr_projects_raw,
                                repli_cases_projects)),
  
  ## Update ----
  tar_target(rr_attempts_minted,
             update_attempts_minted(rr_attempts_minted_raw,
                                    rr_attempts_minted_changelog))
)
```



Replications/Reproductions variables data. QC'ed and merged.

```{targets processed-rr}
list(
  # Transform replication form data
  tar_target(replication_qa,
             transform_replication_qa(replication_qa_raw,
                                      rr_attempts_minted)),
  
  tar_target(repli_merged,
             merge_repli_input(rr_outcomes_dataset_p1,
                               replication_qa,
                               rr_reporting_checkin,
                               replication_cases,
                               effectsize_repli)),
  
  tar_target(repli_export,
             export_repli(repli_merged,
                          repli_input_changelog)),
  
  # Reproduction targets ----
  # Transformed data from forms
  tar_target(repro_data_entry,
             transform_repro_input(reproduction_qa)),
  
  # Transform reproduction claims
  tar_target(rr_confrontations_repro_claim,
             transform_repro_claims(prereg_checkin_repro)),
  
  # Merge with additional cases
  tar_target(repro_merged,
             merge_repro(repro_data_entry,
                         reproduction_cases,
                         repro_vor)),
  
  # Update transformed data from forms
  tar_target(repro_export,
             update_repro(repro_merged,
                          p2_repro_input_changelog)),
  
  # Create repro supplement
  tar_target(repro_supplement_raw,
             transform_repro_outcomes(repro_export,
                                      orig_dataset,
                                      rr_confrontations_repro_claim)),
  
  tar_target(repro_supplement,
             update_repro_supplement(repro_supplement_raw,
                                     repro_supplement_changelog))
)
```

Process reproducibility data. 

```{targets processed-pr}

list(

  tar_target(oa_raw,
             load_process_oa(oa_sheet)),
  
  tar_target(oa_outreach,
             update_oa(oa_raw,
                       oa_changelog)),
  
  tar_target(pr_data_form,
             process_pr_data(pr_data_raw,
                           covid_ta2,
                           tagtable_covid_p1)),
           
  tar_target(pr_qc,
             update_pr(pr_data_form,
                       pr_input_changelog))
  
)

```

## Analysis-ready Data

```{targets analytic-data}
list(
  # Information about journals the original studies were from as well as
  # some journal policy information
  tar_target(publications,
             left_join(journal_metadata_updated,
                       journal_top_factor,
                       by = join_by(publication_standard == Journal))),
  
  # Information about individual articles that claims were extracted from
  tar_target(paper_metadata,
             merge_paper_metadata(non_covid_metadata,
                                  covid_metadata,
                                  paper_cite,
                                  publications)),
  
  # Claims made in original studies 
  tar_target(extracted_claims,
             merge_claims(tagtable_p1,
                          tagtable_covid_p1,
                          tagtable_p2_CES,
                          stitched_claims,
                          complex_bushel,
                          status,
                          covid_metadata)),
  
  # Original study variables
  tar_target(orig_outcomes,
             create_ov_analytic(orig_dataset,
                                complex_bushel,
                                effectsize_orig,
                                effectsize_outcome,
                                repli_export)),
  
  # Replication study variables
  tar_target(repli_outcomes,
             create_repli_analytic(repli_export,
                                   rr_attempts_minted,
                                   rr_statistics_output_p2,
                                   status,
                                   stitched_claims,
                                   effectsize_outcome,
                                   orig_outcomes,
                                   paper_metadata,
                                   repli_case_exclusions)),

  tar_target(repli_binary,
             calculate_repli_binary(repli_outcomes,
                                    orig_outcomes,
                                    paper_metadata)),
  
  # Reproduction study variables
  tar_target(repro_outcomes,
             create_repro_analytic(repro_export,
                                   repro_supplement)),
  
  # Process Reproducibility 
  tar_target(pr_outcomes,
             create_pr_analytic(pr_qc, oa_outreach))
)
```

# Run Pipeline

Run the `{targets}` pipeline. Expected warnings:

1) orig_statistics_dataset_p1: One or more parsing issues
2) replication_qa: There was 1 warning in mutate
3) rr_confrontations_repro_claim: There was 1 warning in mutate.

```{r make}
tar_make()

targets::tar_meta(fields = warnings, complete_only = TRUE)
```

# Output

You can retrieve results from the `_targets/` data store using `tar_read()` or `tar_load()`.

The `targets` dependency graph shows the steps of the pipeline at a high level.

```{r visnetwork}
tar_visnetwork()
```
